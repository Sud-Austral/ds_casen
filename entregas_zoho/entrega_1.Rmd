---
title: |
  <h3>
  Generación de ttcc sobre variables de interés para La Casen en diferentes años
  </h3>
author:
- name: VE-CC
  affiliation: DataIntelligence
subtitle: |
  
date: "27-04-2021"
abstract: |

  Aparte de la generación de las tablas, también se crearon los diccionarios y códigos para las variables de estudio. También se llegó a la conclusión de que se deberían usar las tablas Casen del año 2011-2017 ya que es donde las variables tienen mayos representación, a diferencia de las tablas de 2006 y 2009 donde son pocas las variables y categorías de respuesta de las mismas 
  
output: 
 html_document:
  toc: true
  toc_float: true
---

```{r , message=FALSE, warning=FALSE, include = FALSE, echo = FALSE}

suppressWarnings(library(RODBC))

library(ggplot2)
library(ggpubr)
library(markdown)
library(shiny)
library(shinythemes)
library(tidyverse)
library(magrittr)
library(lubridate)
library(plotly)
library(xts)
library(dygraphs)
library(kableExtra)
library(knitr)
library("readxl")
library(rsconnect)
library(dplyr)
library(summarytools)
library(epiDisplay)
#library(leaflet)
library(haven)
library(epiDisplay)
library("readxl")
library(expss)
library(hrbrthemes)
library(viridis)
library(viridisLite)
library(DescTools)
library(roperators)
library(shinycssloaders)
library(writexl)
library(labelled)
library(tidyverse)
library(haven)
library(readr)
library(sjmisc)
library(WriteXLS)

library(ineq)
library(readstata13)
library(reldist)

library(RPostgreSQL)
library(devtools)
library(remotes)
library(DBI)
```



# Lectura de tablas Casen

```{r}
dataset_2006 <- readRDS(file = "casen_2006_c.rds")
dataset_2006 <- dataset_2006[,c("COMUNA","S10B","S10A","T1A","T4","E1","SEXO","EXPC")]

dataset_2009 <- readRDS(file = "casen_2009_c.rds")
dataset_2009 <- dataset_2009[,c("COMUNA","S16B","S16A","T1A","T5","E1","SEXO","EXPC")]

dataset_2011 <- readRDS(file = "casen_2011_c.rds")
dataset_2011 <- dataset_2011[,c("comuna","s16","s15","s27b","s27a","s37t1","r6","e1","sexo","expc_full")]

dataset_2013 <- readRDS(file = "casen_2013_c.rds")
dataset_2013 <- dataset_2013[,c("comuna","s13","s12","s24b","s24a","s34t1","r6","e1","sexo","expc")]

dataset_2015 <- readRDS(file = "casen_2015_c.rds")
dataset_2015 <- dataset_2015[,c("comuna","s11","s10","s21b","s21a","s31c1","r3","e1","sexo","expc_todas")]

dataset_2017 <- readRDS(file = "casen_2017_c.rds")
dataset_2017 <- dataset_2017[,c("comuna","s11","s10","s21b","s21a","s31a1","r3","e1","sexo","expc")]

```


<br>
<hr style="height:1px;border-width:1;color:Gray;background-color:Gray">
<br>


# ttcc-Discapacidad

```{r}
funcion1 <- function(n){
  
  comunales<-switch(n, "codigos_comunales_2006.rds","codigos_comunales_2009.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds")
 xx<-switch(n, "2006","2009","2011","2013","2015","2017")
 # dataset_06 <<- NA
 

 if(xx==2006) { 
  eliminated <- dataset_2006
# a <- eliminated$ytotaj 
b <- eliminated$COMUNA
c <- eliminated$T1A
d <- eliminated$E1 #alfabetismo
e <- eliminated$T4 #etnia
f <- eliminated$SEXO
anio <- 2006
cross_tab =  xtabs(eliminated$EXPC ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$EXPC ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}
 
 if(xx==2009) { 
  eliminated <- dataset_2009
# a <- eliminated$ytotaj 
b <- eliminated$COMUNA
c <- eliminated$T1A
d <- eliminated$E1 #alfabetismo
e <- eliminated$T5 #etnia
f <- eliminated$SEXO
anio <- 2009
cross_tab =  xtabs(eliminated$EXPC ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$EXPC ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
 }
 
if(xx==2011) { 
  eliminated <- dataset_2011
# a <- eliminated$ytotaj 
b <- eliminated$comuna
c <- eliminated$s37t1
d <- eliminated$e1 #alfabetismo
e <- eliminated$r6 #etnia
f <- eliminated$sexo
anio <- 2011
cross_tab =  xtabs(eliminated$expc_full ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc_full ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}
 
if(xx==2013) { 
  eliminated <- dataset_2013
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s34t1
d <- eliminated$e1 #alfabetismo
e <- eliminated$r6 #etnia
f <- eliminated$sexo
anio <- 2013
cross_tab =  xtabs(eliminated$expc ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}
 
if(xx==2015) { 
  eliminated <- dataset_2015
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s31c1
d <- eliminated$e1 #alfabetismo
e <- eliminated$r3 #etnia
f <- eliminated$sexo
anio <- 2015
cross_tab =  xtabs(eliminated$expc_todas ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc_todas ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}
 
if(xx==2017) { 
  eliminated <- dataset_2017
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s31a1
d <- eliminated$e1 #alfabetismo
e <- eliminated$r3 #etnia
f <- eliminated$sexo
anio <- 2017
cross_tab =  xtabs(eliminated$expc ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}



tabla <- as.data.frame(cross_tab)
d <-tabla[!(tabla$Freq == 0),]
d$Año <- anio 

names(d)[1] <- "Comuna"
names(d)[2] <- "discapacidad"
names(d)[3] <- "Alfabetismo"
names(d)[4] <- "Etnia"
names(d)[5] <- "sexo"
codigos_comunales <- readRDS(file = comunales)
names(codigos_comunales)[1] <- "Código"
names(codigos_comunales)[2] <- "Comuna"
# codigos_comunales

df = merge( x = d, y = codigos_comunales, by = "Comuna", all.x = TRUE)

ingreso_rds <- paste("tablas_peque/discapacidad_",anio,".rds", sep="")
saveRDS(df,ingreso_rds)

# print(head(df,10))

}

for (n in 1:6){
  funcion1(n)
}
```

## Tratamientos


### Union de tablas

Unión de subtablas, homologación de categorías de respuesta con código independiente para la variable de estudio de la ttcc y creación de la tabla general.

```{r}
receptaculo <- data.frame()
for (n in 1 : 6){
    numero <- switch(n, "2006","2009","2011","2013","2015","2017")
    direc_tablas <- paste("tablas_peque/discapacidad_",numero,".rds", sep="")
    tablas <- readRDS(direc_tablas)

    receptaculo <<- rbind(receptaculo, tablas)
    
}
```

### Diccionario

Para la creación del diccionario se necesita el dataset “receptáculo” al que se le hará un **unique()** en la columna a la que se le hará el diccionario, luego se guarda como **xlsx** para hacer el tratamiento 

```{r}
# receptaculo_unicos <- unique(receptaculo$discapacidad)
# receptaculo_unicos <- as.data.frame(receptaculo_unicos)
# write_xlsx(receptaculo_unicos,"tablas_grandes/cat_discapacidad.xlsx")
```


```{r}
alfabetismo <- read_xlsx("diccionario/alfabetismo_unicos.xlsx")
categorias <- read_xlsx("diccionario/categorias_etnia.xlsx")
cat_disc <- read_xlsx("diccionario/cat_discapacidad.xlsx")

cod_cat <- unique(cat_disc$discapacidad_n)
cod_cat<- as.data.frame(cod_cat)
cod_cat$codigo_discapacidad <- paste("00",seq(1:nrow(cod_cat)), sep = "")
names(cod_cat)[1] <- "discapacidad_n"
cat_disc = merge( x = cat_disc, y = cod_cat, by = "discapacidad_n", all.x = TRUE)
cat_disc <- cat_disc[,c(2,1,3)]


nuevas_cat = merge( x = receptaculo, y = alfabetismo, by = "Alfabetismo", all.x = TRUE)
alfa_corr <- nuevas_cat[,c(-1)]


categoriasbuenas = merge( x = alfa_corr, y = categorias, by = "Etnia", all.x = TRUE)
etnia_corr <- categoriasbuenas[,c(-1)]

categoriasbuenas = merge( x = etnia_corr, y = cat_disc, by = "discapacidad", all.x = TRUE)
discapacidad_corr <- categoriasbuenas[,c(-1)]

receptaculo<-discapacidad_corr[,c(1,10,11,8,9,6,7,2,3,4,5)]

names(receptaculo)[1] <- "comuna"
names(receptaculo)[2] <- "discapacidad"
names(receptaculo)[4] <- "etnia"
names(receptaculo)[6] <- "alfabetismo"
names(receptaculo)[8] <- "sexo"
names(receptaculo)[9] <- "frec"
names(receptaculo)[10] <- "anio"
names(receptaculo)[11] <- "codigo_comuna"

receptaculo_tab <- receptaculo[1:30,]
kbl(receptaculo_tab) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "500px")
```

### Guardado de tablas

El siguiente código establece una conexión con nuestra base de datos en **postgres** donde estaremos guardando la tabla resultado del código previo.
También se guardará la tabla de forma local en formato **xlsx**

```{r}
db <- 'trabajo-con-casen'  #provide the name of your db
host_db <- 'post-to-r.postgres.database.azure.com' #i.e. # i.e. 'ec2-54-83-201-96.compute-1.amazonaws.com'  
db_port <- '5432'  # or any other port specified by the DBA
db_user <- 'yomismo@post-to-r'  
db_password <- '123456Fg*'
con <- dbConnect(RPostgres::Postgres(), dbname = db, host=host_db, port=db_port, user=db_user, password=db_password) 

library('RPostgreSQL')
# tn <- 'links'
# dbWriteTable(con,'tabla_discapacidad',receptaculo, row.names=FALSE)

#write_xlsx(receptaculo,"tablas_grandes/tabla_discapacidad.xlsx")
```


```{r}
rrrr <- dir(pattern = ".xlsx")
rrrr
```


```{r}
aaaa <- read_xlsx("entrega_1_discapacidad.xlsx")
dbWriteTable(con,'entrega_1_discapacidad',aaaa, row.names=FALSE)
```



```{r}
# tabla_grande <- dbGetQuery(con, 'SELECT * FROM tabla_discapacidad') 
# tabla_grande
```

## Gráficos 

### Gráfico I

```{r}
p1 <- plot_ly(receptaculo , x = ~anio , color = ~discapacidad) %>% add_histogram() %>%
    layout(title = "Discapacidad en los años",
         xaxis = list(title = "Años"),showlegend = TRUE, autosize = F, legend = list(font = list(size = 8)))
p1
```

### Gráfico II

```{r}
p2 <- plot_ly(receptaculo , x = ~etnia , color = ~discapacidad)  %>% add_histogram()%>%
    layout(title = "Discapacidad por grupo etnico",
         xaxis = list(title = "Etnia"),showlegend = TRUE, autosize = F, legend = list(font = list(size = 8)))
p2
```


<br>
<hr style="height:1px;border-width:1;color:Gray;background-color:Gray">
<br>



# ttcc-Consultas de salud mental

```{r, message=FALSE, warning=FALSE, results='hide'}
funcion1 <- function(n){

  comunales<-switch(n, "codigos_comunales_2006.rds","codigos_comunales_2009.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds")
 xx<-switch(n, "2006","2009","2011","2013","2015","2017")
 # dataset_06 <<- NA


 if(xx==2006) {
  eliminated <- dataset_2006#[!is.na(dataset_2006 ),]
# a <- eliminated$ytotaj
b <- eliminated$COMUNA
c <- eliminated$S10A
d <- eliminated$E1 #alfabetismo
e <- eliminated$T4 #etnia
f <- eliminated$SEXO
anio <- 2006
cross_tab =  xtabs(eliminated$EXPC ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$EXPC ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

 if(xx==2009) {
  eliminated <- dataset_2009#[!is.na(dataset_2009),]
# a <- eliminated$ytotaj
b <- eliminated$COMUNA
c <- eliminated$S16A
d <- eliminated$E1 #alfabetismo
e <- eliminated$T5 #etnia
f <- eliminated$SEXO
anio <- 2009
cross_tab =  xtabs(eliminated$EXPC ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$EXPC ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
 }

 if(xx==2011) {
  eliminated <- dataset_2011#[!is.na(dataset_2011),]
# a <- eliminated$ytotaj
b <- eliminated$comuna
c <- eliminated$s27a
d <- eliminated$e1 #alfabetismo
e <- eliminated$r6 #etnia
f <- eliminated$sexo
anio <- 2011
cross_tab =  xtabs(eliminated$expc_full ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc_full ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

if(xx==2013) {
  eliminated <- dataset_2013#[!is.na(dataset_2013),]
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s24a
d <- eliminated$e1 #alfabetismo
e <- eliminated$r6 #etnia
f <- eliminated$sexo
anio <- 2013
cross_tab =  xtabs(eliminated$expc ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

if(xx==2015) {
  eliminated <- dataset_2015#[!is.na(dataset_2015),]
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s21a
d <- eliminated$e1 #alfabetismo
e <- eliminated$r3 #etnia
f <- eliminated$sexo
anio <- 2015
cross_tab =  xtabs(eliminated$expc_todas ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc_todas ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

if(xx==2017) {
  eliminated <- dataset_2017#[!is.na(dataset_2017),]
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s21a
d <- eliminated$e1 #alfabetismo
e <- eliminated$r3 #etnia
f <- eliminated$sexo
anio <- 2017
cross_tab =  xtabs(eliminated$expc ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}



tabla <- as.data.frame(cross_tab)
d <-tabla[!(tabla$Freq == 0),]
d$Año <- anio

names(d)[1] <- "Comuna"
names(d)[2] <- "consultas"
names(d)[3] <- "Alfabetismo"
names(d)[4] <- "Etnia"
names(d)[5] <- "sexo"
codigos_comunales <- readRDS(file = comunales)
names(codigos_comunales)[1] <- "Código"
names(codigos_comunales)[2] <- "Comuna"
# codigos_comunales

df = merge( x = d, y = codigos_comunales, by = "Comuna", all.x = TRUE)

ingreso_rds <- paste("tablas_peque/mental_",anio,".rds", sep="")
saveRDS(df,ingreso_rds)

# print(head(df,10))

}
for (n in 1:6){
  funcion1(n)
}
```

## Tratamientos

Unión de subtablas, homologación de categorías de respuesta con código independiente para la variable de estudio de la ttcc y creación de la tabla general.

```{r}
receptaculo <- data.frame()
for (n in 1 : 6){
    numero <- switch(n, "2006","2009","2011","2013","2015","2017")
    direc_tablas <- paste("tablas_peque/mental_",numero,".rds", sep="")
    tablas <- readRDS(direc_tablas)

    receptaculo <<- rbind(receptaculo, tablas)

}
```

### Diccionario

Para la creación del diccionario se necesita el dataset “receptáculo” al que se le hará un **unique()** en la columna a la que se le hará el diccionario, luego se guarda como **xlsx** para hacer el tratamiento 

```{r}
# receptaculo_unicos <- unique(receptaculo$discapacidad)
# receptaculo_unicos <- as.data.frame(receptaculo_unicos)
# write_xlsx(receptaculo_unicos,"tablas_grandes/unicos_mental.xlsx")
```

```{r}
alfabetismo <- read_xlsx("diccionario/alfabetismo_unicos.xlsx")
categorias <- read_xlsx("diccionario/categorias_etnia.xlsx")
cat_disc <- read_xlsx("diccionario/unicos_mental.xlsx")

nuevas_cat = merge( x = receptaculo, y = alfabetismo, by = "Alfabetismo", all.x = TRUE)
alfa_corr <- nuevas_cat[,c(-1)]


categoriasbuenas = merge( x = alfa_corr, y = categorias, by = "Etnia", all.x = TRUE)
etnia_corr <- categoriasbuenas[,c(-1)]

categoriasbuenas = merge( x = etnia_corr, y = cat_disc, by = "consultas", all.x = TRUE)
discapacidad_corr <- categoriasbuenas[,c(-1)]

receptaculo<-discapacidad_corr[,c(1,10,8,9,6,7,2,3,4,5)]

names(receptaculo)[1] <- "comuna"
names(receptaculo)[2] <- "consultas"
names(receptaculo)[3] <- "etnia"
names(receptaculo)[5] <- "alfabetismo"
names(receptaculo)[7] <- "sexo"
names(receptaculo)[8] <- "frec"
names(receptaculo)[9] <- "anio"
names(receptaculo)[10] <- "codigo_comuna"

receptaculo_tab <- receptaculo[1:30,]
kbl(receptaculo_tab) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "500px")
```

### Guardado de tablas

El siguiente código establece una conexión con nuestra base de datos en **postgres** donde estaremos guardando la tabla resultado del código previo.
También se guardará la tabla de forma local en formato **xlsx**

```{r}
db <- 'trabajo-con-casen'  #provide the name of your db
host_db <- 'post-to-r.postgres.database.azure.com' #i.e. # i.e. 'ec2-54-83-201-96.compute-1.amazonaws.com'  
db_port <- '5432'  # or any other port specified by the DBA
db_user <- 'yomismo@post-to-r'  
db_password <- '123456Fg*'
con <- dbConnect(RPostgres::Postgres(), dbname = db, host=host_db, port=db_port, user=db_user, password=db_password) 

library('RPostgreSQL')
# tn <- 'links'
dbWriteTable(con,'tabla_consulta_mental',receptaculo, row.names=FALSE)

write_xlsx(receptaculo,"tablas_grandes/tabla_consulta_mental.xlsx")
```
```{r}
# tabla_grande <- dbGetQuery(con, 'SELECT * FROM tabla_discapacidad') 
# tabla_grande
```



## Gráficos 

### Gráfico I

```{r}
p1 <- plot_ly(receptaculo , x = ~anio , color = ~consultas) %>% add_histogram() %>%
    layout(title = "consultas en los años",
         xaxis = list(title = "Años"),showlegend = TRUE, autosize = F, legend = list(font = list(size = 8)))
p1
```

### Gráfico II

```{r}
p2 <- plot_ly(receptaculo , x = ~etnia , color = ~consultas)  %>% add_histogram()%>%
    layout(title = "consultas por grupo etnico",
         xaxis = list(title = "Etnia"),showlegend = TRUE, autosize = F, legend = list(font = list(size = 8)))
p2
```


<br>
<hr style="height:1px;border-width:1;color:Gray;background-color:Gray">
<br>


# ttcc-Lugar de consultas de salud mental

```{r, message=FALSE, warning=FALSE, results='hide'}
funcion1 <- function(n){

  comunales<-switch(n, "codigos_comunales_2006.rds","codigos_comunales_2009.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds")
 xx<-switch(n, "2006","2009","2011","2013","2015","2017")
 # dataset_06 <<- NA


 if(xx==2006) {
  eliminated <- dataset_2006#[!is.na(dataset_2006 ),]
# a <- eliminated$ytotaj
b <- eliminated$COMUNA
c <- eliminated$S10B
d <- eliminated$E1 #alfabetismo
e <- eliminated$T4 #etnia
f <- eliminated$SEXO
anio <- 2006
cross_tab =  xtabs(eliminated$EXPC ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$EXPC ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

 if(xx==2009) {
  eliminated <- dataset_2009#[!is.na(dataset_2009),]
# a <- eliminated$ytotaj
b <- eliminated$COMUNA
c <- eliminated$S16B
d <- eliminated$E1 #alfabetismo
e <- eliminated$T5 #etnia
f <- eliminated$SEXO
anio <- 2009
cross_tab =  xtabs(eliminated$EXPC ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$EXPC ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
 }

 if(xx==2011) {
  eliminated <- dataset_2011#[!is.na(dataset_2011),]
# a <- eliminated$ytotaj
b <- eliminated$comuna
c <- eliminated$s27b
d <- eliminated$e1 #alfabetismo
e <- eliminated$r6 #etnia
f <- eliminated$sexo
anio <- 2011
cross_tab =  xtabs(eliminated$expc_full ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc_full ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

if(xx==2013) {
  eliminated <- dataset_2013#[!is.na(dataset_2013),]
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s24b
d <- eliminated$e1 #alfabetismo
e <- eliminated$r6 #etnia
f <- eliminated$sexo
anio <- 2013
cross_tab =  xtabs(eliminated$expc ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

if(xx==2015) {
  eliminated <- dataset_2015#[!is.na(dataset_2015),]
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s21b
d <- eliminated$e1 #alfabetismo
e <- eliminated$r3 #etnia
f <- eliminated$sexo
anio <- 2015
cross_tab =  xtabs(eliminated$expc_todas ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc_todas ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

if(xx==2017) {
  eliminated <- dataset_2017#[!is.na(dataset_2017),]
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s21b
d <- eliminated$e1 #alfabetismo
e <- eliminated$r3 #etnia
f <- eliminated$sexo
anio <- 2017
cross_tab =  xtabs(eliminated$expc ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}



tabla <- as.data.frame(cross_tab)
d <-tabla[!(tabla$Freq == 0),]
d$Año <- anio

names(d)[1] <- "Comuna"
names(d)[2] <- "lugat_de_consultas"
names(d)[3] <- "Alfabetismo"
names(d)[4] <- "Etnia"
names(d)[5] <- "sexo"
codigos_comunales <- readRDS(file = comunales)
names(codigos_comunales)[1] <- "Código"
names(codigos_comunales)[2] <- "Comuna"
# codigos_comunales

df = merge( x = d, y = codigos_comunales, by = "Comuna", all.x = TRUE)

ingreso_rds <- paste("tablas_peque/lugar_mental_",anio,".rds", sep="")
saveRDS(df,ingreso_rds)

# print(head(df,10))

}
for (n in 1:6){
  funcion1(n)
}
```

## Tratamientos

Unión de subtablas, homologación de categorías de respuesta con código independiente para la variable de estudio de la ttcc y creación de la tabla general.

```{r}
receptaculo <- data.frame()
for (n in 1 : 6){
    numero <- switch(n, "2006","2009","2011","2013","2015","2017")
    direc_tablas <- paste("tablas_peque/lugar_mental_",numero,".rds", sep="")
    tablas <- readRDS(direc_tablas)

    receptaculo <<- rbind(receptaculo, tablas)

}
```

### Diccionario

Para la creación del diccionario se necesita el dataset “receptáculo” al que se le hará un **unique()** en la columna a la que se le hará el diccionario, luego se guarda como **xlsx** para hacer el tratamiento 

```{r}
# receptaculo_unicos <- unique(receptaculo$lugat_de_consultas)
# receptaculo_unicos <- as.data.frame(receptaculo_unicos)
# write_xlsx(receptaculo_unicos,"diccionario/unico_lugar_consulta_mental.xlsx")
```

```{r}
alfabetismo <- read_xlsx("diccionario/alfabetismo_unicos.xlsx")
categorias <- read_xlsx("diccionario/categorias_etnia.xlsx")
cat_disc <- read_xlsx("diccionario/unico_lugar_consulta_mental.xlsx")

cod_cat <- unique(cat_disc$lugat_de_consultas_cat)
cod_cat<- as.data.frame(cod_cat)
rango <- seq(1:nrow(cod_cat))
cadena<- paste("00",seq(1:nrow(cod_cat)), sep = "")
cadena <- substr(cadena,(nchar(cadena)[rango])-(4-2),5)
cod_cat$codigo_discapacidad <- cadena
names(cod_cat)[1] <- "lugat_de_consultas_cat"
cat_disc = merge( x = cat_disc, y = cod_cat, by = "lugat_de_consultas_cat", all.x = TRUE)
cat_disc <- cat_disc[,c(2,1,3)]


nuevas_cat = merge( x = receptaculo, y = alfabetismo, by = "Alfabetismo", all.x = TRUE)
alfa_corr <- nuevas_cat[,c(-1)]

categoriasbuenas = merge( x = alfa_corr, y = categorias, by = "Etnia", all.x = TRUE)
etnia_corr <- categoriasbuenas[,c(-1)]

categoriasbuenas = merge( x = etnia_corr, y = cat_disc, by = "lugat_de_consultas", all.x = TRUE)
discapacidad_corr <- categoriasbuenas[,c(-1)]


receptaculo<-discapacidad_corr[,c(1,10,11,8,9,6,7,2,3,4,5)]

names(receptaculo)[1] <- "comuna"
names(receptaculo)[2] <- "lugar_de_consultas"
names(receptaculo)[4] <- "etnia"
names(receptaculo)[6] <- "alfabetismo"
names(receptaculo)[8] <- "sexo"
names(receptaculo)[9] <- "frec"
names(receptaculo)[10] <- "anio"
names(receptaculo)[11] <- "codigo_comuna"

receptaculo_tab <- receptaculo[1:30,]
kbl(receptaculo_tab) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "500px")
 

```

### Guardado de tablas

El siguiente código establece una conexión con nuestra base de datos en **postgres** donde estaremos guardando la tabla resultado del código previo.
También se guardará la tabla de forma local en formato **xlsx**

```{r}
db <- 'trabajo-con-casen'  #provide the name of your db
host_db <- 'post-to-r.postgres.database.azure.com' #i.e. # i.e. 'ec2-54-83-201-96.compute-1.amazonaws.com'  
db_port <- '5432'  # or any other port specified by the DBA
db_user <- 'yomismo@post-to-r'  
db_password <- '123456Fg*'
con <- dbConnect(RPostgres::Postgres(), dbname = db, host=host_db, port=db_port, user=db_user, password=db_password) 

library('RPostgreSQL')
# tn <- 'links'
dbWriteTable(con,'tabla_lugar_consulta_mental',receptaculo, row.names=FALSE)

write_xlsx(receptaculo,"tablas_grandes/tabla_lugar_consulta_mental.xlsx")
```
```{r}
# tabla_grande <- dbGetQuery(con, 'SELECT * FROM tabla_discapacidad') 
# tabla_grande
```
## Gráficos 

### Gráfico I

```{r}
p1 <- plot_ly(receptaculo , x = ~anio , color = ~lugar_de_consultas) %>% add_histogram() %>%
    layout(title = "lugar_de_consultas en los años",
         xaxis = list(title = "Años"),showlegend = TRUE, autosize = F, legend = list(font = list(size = 8)))
p1
```

### Gráfico II

```{r}
p2 <- plot_ly(receptaculo , x = ~etnia , color = ~lugar_de_consultas)  %>% add_histogram()%>%
    layout(title = "lugar_de_consultas por grupo etnico",
         xaxis = list(title = "Etnia"),showlegend = TRUE, autosize = F, legend = list(font = list(size = 8)))
p2
```


<br>
<hr style="height:1px;border-width:1;color:Gray;background-color:Gray">
<br>

# ttcc-Práctica de mamografía


```{r, message=FALSE, warning=FALSE, results='hide'}
funcion1 <- function(n){

  comunales<-switch(n,"codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds")
 xx<-switch(n,"2011","2013","2015","2017")


 if(xx==2011) {
  eliminated <- dataset_2011#[!is.na(dataset_2011),]
# a <- eliminated$ytotaj
b <- eliminated$comuna
c <- eliminated$s15
d <- eliminated$e1 #alfabetismo
e <- eliminated$r6 #etnia
f <- eliminated$sexo
anio <- 2011
cross_tab =  xtabs(eliminated$expc_full ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc_full ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

if(xx==2013) {
  eliminated <- dataset_2013#[!is.na(dataset_2013),]
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s12
d <- eliminated$e1 #alfabetismo
e <- eliminated$r6 #etnia
f <- eliminated$sexo
anio <- 2013
cross_tab =  xtabs(eliminated$expc ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

if(xx==2015) {
  eliminated <- dataset_2015#[!is.na(dataset_2015),]
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s10
d <- eliminated$e1 #alfabetismo
e <- eliminated$r3 #etnia
f <- eliminated$sexo
anio <- 2015
cross_tab =  xtabs(eliminated$expc_todas ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc_todas ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

if(xx==2017) {
  eliminated <- dataset_2017#[!is.na(dataset_2017),]
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s10
d <- eliminated$e1 #alfabetismo
e <- eliminated$r3 #etnia
f <- eliminated$sexo
anio <- 2017
cross_tab =  xtabs(eliminated$expc ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}



tabla <- as.data.frame(cross_tab)
d <-tabla[!(tabla$Freq == 0),]
d$Año <- anio

names(d)[1] <- "Comuna"
names(d)[2] <- "mamografia"
names(d)[3] <- "Alfabetismo"
names(d)[4] <- "Etnia"
names(d)[5] <- "sexo"
codigos_comunales <- readRDS(file = comunales)
names(codigos_comunales)[1] <- "Código"
names(codigos_comunales)[2] <- "Comuna"
# codigos_comunales

df = merge( x = d, y = codigos_comunales, by = "Comuna", all.x = TRUE)

ingreso_rds <- paste("tablas_peque/mamografia_",anio,".rds", sep="")
saveRDS(df,ingreso_rds)

# print(head(df,10))

}
for (n in 1:4){
  funcion1(n)
}
```

## Tratamientos

Unión de subtablas, homologación de categorías de respuesta con código independiente para la variable de estudio de la ttcc y creación de la tabla general.

```{r}
receptaculo <- data.frame()
for (n in 1 : 4){
    numero <- switch(n,"2011","2013","2015","2017")
    direc_tablas <- paste("tablas_peque/mamografia_",numero,".rds", sep="")
    tablas <- readRDS(direc_tablas)

    receptaculo <<- rbind(receptaculo, tablas)

}
```

### Diccionario

Para la creación del diccionario se necesita el dataset “receptáculo” al que se le hará un **unique()** en la columna a la que se le hará el diccionario, luego se guarda como **xlsx** para hacer el tratamiento 

```{r}
# receptaculo_unicos <- unique(receptaculo$mamografia)
# receptaculo_unicos <- as.data.frame(receptaculo_unicos)
# write_xlsx(receptaculo_unicos,"diccionario/unico_mamografia.xlsx")
```


```{r}
alfabetismo <- read_xlsx("diccionario/alfabetismo_unicos.xlsx")
categorias <- read_xlsx("diccionario/categorias_etnia.xlsx")
cat_disc <- read_xlsx("diccionario/unico_mamografia.xlsx")

cod_cat <- unique(cat_disc$mamografia_cat)
cod_cat<- as.data.frame(cod_cat)
cod_cat$codigo_discapacidad <- paste("00",seq(1:nrow(cod_cat)), sep = "")
names(cod_cat)[1] <- "mamografia_cat"
cat_disc = merge( x = cat_disc, y = cod_cat, by = "mamografia_cat", all.x = TRUE)
cat_disc <- cat_disc[,c(2,1,3)]

nuevas_cat = merge( x = receptaculo, y = alfabetismo, by = "Alfabetismo", all.x = TRUE)
alfa_corr <- nuevas_cat[,c(-1)]


categoriasbuenas = merge( x = alfa_corr, y = categorias, by = "Etnia", all.x = TRUE)
etnia_corr <- categoriasbuenas[,c(-1)]

categoriasbuenas = merge( x = etnia_corr, y = cat_disc, by = "mamografia", all.x = TRUE)
discapacidad_corr <- categoriasbuenas[,c(-1)]

receptaculo<-discapacidad_corr[,c(1,10,11,8,9,6,7,2,3,4,5)]

names(receptaculo)[1] <- "comuna"
names(receptaculo)[2] <- "mamografia"
names(receptaculo)[4] <- "etnia"
names(receptaculo)[6] <- "alfabetismo"
names(receptaculo)[8] <- "sexo"
names(receptaculo)[9] <- "frec"
names(receptaculo)[10] <- "anio"
names(receptaculo)[11] <- "codigo_comuna"

receptaculo_tab <- receptaculo[1:30,]
kbl(receptaculo_tab) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "500px")

 

```

### Guardado de tablas

El siguiente código establece una conexión con nuestra base de datos en **postgres** donde estaremos guardando la tabla resultado del código previo.
También se guardará la tabla de forma local en formato **xlsx**

```{r}
db <- 'trabajo-con-casen'  #provide the name of your db
host_db <- 'post-to-r.postgres.database.azure.com' #i.e. # i.e. 'ec2-54-83-201-96.compute-1.amazonaws.com'  
db_port <- '5432'  # or any other port specified by the DBA
db_user <- 'yomismo@post-to-r'  
db_password <- '123456Fg*'
con <- dbConnect(RPostgres::Postgres(), dbname = db, host=host_db, port=db_port, user=db_user, password=db_password) 

library('RPostgreSQL')
# tn <- 'links'
dbWriteTable(con,'tabla_practica_mamografia',receptaculo, row.names=FALSE)

write_xlsx(receptaculo,"tablas_grandes/tabla_practica_mamografia.xlsx")
```
```{r}
# tabla_grande <- dbGetQuery(con, 'SELECT * FROM tabla_discapacidad') 
# tabla_grande
```

## Gráficos 

### Gráfico I

```{r}
p1 <- plot_ly(receptaculo , x = ~anio , color = ~mamografia) %>% add_histogram() %>%
    layout(title = "Practica de mamografía en los años",
         xaxis = list(title = "Años"),showlegend = TRUE, autosize = F, legend = list(font = list(size = 8)))
p1
```

### Gráfico II

```{r}
p2 <- plot_ly(receptaculo , x = ~etnia , color = ~mamografia)  %>% add_histogram()%>%
    layout(title = "Practica de mamografía por grupo etnico",
         xaxis = list(title = "Etnia"),showlegend = TRUE, autosize = F, legend = list(font = list(size = 8)))
p2
```

<br>
<hr style="height:1px;border-width:1;color:Gray;background-color:Gray">
<br>

# ttcc-Razon de práctica de mamografía


```{r, message=FALSE, warning=FALSE, results='hide'}
funcion1 <- function(n){

  comunales<-switch(n,"codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds","codigos_comunales_2011-2017.rds")
 xx<-switch(n,"2011","2013","2015","2017")


 if(xx==2011) {
  eliminated <- dataset_2011#[!is.na(dataset_2011),]
# a <- eliminated$ytotaj
b <- eliminated$comuna
c <- eliminated$s16
d <- eliminated$e1 #alfabetismo
e <- eliminated$r6 #etnia
f <- eliminated$sexo
anio <- 2011
cross_tab =  xtabs(eliminated$expc_full ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc_full ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

if(xx==2013) {
  eliminated <- dataset_2013#[!is.na(dataset_2013),]
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s13
d <- eliminated$e1 #alfabetismo
e <- eliminated$r6 #etnia
f <- eliminated$sexo
anio <- 2013
cross_tab =  xtabs(eliminated$expc ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

if(xx==2015) {
  eliminated <- dataset_2015#[!is.na(dataset_2015),]
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s11
d <- eliminated$e1 #alfabetismo
e <- eliminated$r3 #etnia
f <- eliminated$sexo
anio <- 2015
cross_tab =  xtabs(eliminated$expc_todas ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc_todas ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}

if(xx==2017) {
  eliminated <- dataset_2017#[!is.na(dataset_2017),]
# a <- eliminated$ytotcor
b <- eliminated$comuna
c <- eliminated$s11
d <- eliminated$e1 #alfabetismo
e <- eliminated$r3 #etnia
f <- eliminated$sexo
anio <- 2017
cross_tab =  xtabs(eliminated$expc ~  +  unlist(b) + unlist(c)  + unlist(d)  + unlist(e)+ unlist(f) ,aggregate(eliminated$expc ~  +  unlist(b) + unlist(c) + unlist(d) + unlist(e)+ unlist(f),eliminated,mean))
}



tabla <- as.data.frame(cross_tab)
d <-tabla[!(tabla$Freq == 0),]
d$Año <- anio

names(d)[1] <- "Comuna"
names(d)[2] <- "motivo_mamografia"
names(d)[3] <- "Alfabetismo"
names(d)[4] <- "Etnia"
names(d)[5] <- "sexo"
codigos_comunales <- readRDS(file = comunales)
names(codigos_comunales)[1] <- "Código"
names(codigos_comunales)[2] <- "Comuna"
# codigos_comunales

df = merge( x = d, y = codigos_comunales, by = "Comuna", all.x = TRUE)

ingreso_rds <- paste("tablas_peque/motivo_mamografia_",anio,".rds", sep="")
saveRDS(df,ingreso_rds)

# print(head(df,10))

}
for (n in 1:4){
  funcion1(n)
}
```

## Tratamientos

Unión de subtablas, homologación de categorías de respuesta con código independiente para la variable de estudio de la ttcc y creación de la tabla general.

```{r}
receptaculo <- data.frame()
for (n in 1 : 4){
    numero <- switch(n,"2011","2013","2015","2017")
    direc_tablas <- paste("tablas_peque/motivo_mamografia_",numero,".rds", sep="")
    tablas <- readRDS(direc_tablas)

    receptaculo <<- rbind(receptaculo, tablas)

}
```

### Diccionario

Para la creación del diccionario se necesita el dataset “receptáculo” al que se le hará un **unique()** en la columna a la que se le hará el diccionario, luego se guarda como **xlsx** para hacer el tratamiento 

```{r}
# receptaculo_unicos <- unique(receptaculo$motivo_mamografia)
# receptaculo_unicos <- as.data.frame(receptaculo_unicos)
# write_xlsx(receptaculo_unicos,"diccionario/unico_motivo_mamografia.xlsx")
```

```{r}
alfabetismo <- read_xlsx("diccionario/alfabetismo_unicos.xlsx")
categorias <- read_xlsx("diccionario/categorias_etnia.xlsx")
cat_disc <- read_xlsx("diccionario/unico_motivo_mamografia.xlsx")

cod_cat <- unique(cat_disc$motivo_mamografia_cat)
cod_cat<- as.data.frame(cod_cat)
rango <- seq(1:nrow(cod_cat))
cadena<- paste("00",seq(1:nrow(cod_cat)), sep = "")
cadena <- substr(cadena,(nchar(cadena)[rango])-(4-2),5)
cod_cat$codigo_discapacidad <- cadena
names(cod_cat)[1] <- "motivo_mamografia_cat"
cat_disc = merge( x = cat_disc, y = cod_cat, by = "motivo_mamografia_cat", all.x = TRUE)
cat_disc <- cat_disc[,c(2,1,3)]

nuevas_cat = merge( x = receptaculo, y = alfabetismo, by = "Alfabetismo", all.x = TRUE)
alfa_corr <- nuevas_cat[,c(-1)]


categoriasbuenas = merge( x = alfa_corr, y = categorias, by = "Etnia", all.x = TRUE)
etnia_corr <- categoriasbuenas[,c(-1)]

categoriasbuenas = merge( x = etnia_corr, y = cat_disc, by = "motivo_mamografia", all.x = TRUE)
discapacidad_corr <- categoriasbuenas[,c(-1)]

receptaculo<-discapacidad_corr[,c(1,10,11,8,9,6,7,2,3,4,5)]

names(receptaculo)[1] <- "comuna"
names(receptaculo)[2] <- "motivo_no_mamografia"
names(receptaculo)[4] <- "etnia"
names(receptaculo)[6] <- "alfabetismo"
names(receptaculo)[8] <- "sexo"
names(receptaculo)[9] <- "frec"
names(receptaculo)[10] <- "anio"
names(receptaculo)[11] <- "codigo_comuna"

receptaculo_tab <- receptaculo[1:30,]
kbl(receptaculo_tab) %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_paper() %>%
  scroll_box(width = "100%", height = "500px")

 

```

### Guardado de tablas

El siguiente código establece una conexión con nuestra base de datos en **postgres** donde estaremos guardando la tabla resultado del código previo.
También se guardará la tabla de forma local en formato **xlsx**


```{r}
db <- 'trabajo-con-casen'  #provide the name of your db
host_db <- 'post-to-r.postgres.database.azure.com' #i.e. # i.e. 'ec2-54-83-201-96.compute-1.amazonaws.com'  
db_port <- '5432'  # or any other port specified by the DBA
db_user <- 'yomismo@post-to-r'  
db_password <- '123456Fg*'
con <- dbConnect(RPostgres::Postgres(), dbname = db, host=host_db, port=db_port, user=db_user, password=db_password) 

library('RPostgreSQL')
# tn <- 'links'
dbWriteTable(con,'tabla_no_practica_mamografia',receptaculo, row.names=FALSE)

write_xlsx(receptaculo,"tablas_grandes/tabla_no_practica_mamografia.xlsx")
```
```{r}
# tabla_grande <- dbGetQuery(con, 'SELECT * FROM tabla_discapacidad') 
# tabla_grande
```

## Gráficos 

### Gráfico I

```{r}
p1 <- plot_ly(receptaculo , x = ~anio , color = ~motivo_no_mamografia) %>% add_histogram() %>%
    layout(title = "Motivo de no practicar una mamografía en los años",
         xaxis = list(title = "Años"),showlegend = TRUE, autosize = F, legend = list(font = list(size = 8)))
p1
```

### Gráfico II

```{r}
p2 <- plot_ly(receptaculo , x = ~etnia , color = ~motivo_no_mamografia)  %>% add_histogram()%>%
    layout(title = "Motivo de no practicar una mamografía por grupo etnico",
         xaxis = list(title = "Etnia"),showlegend = TRUE, autosize = F, legend = list(font = list(size = 8)))
p2
```

<br>
<hr style="height:1px;border-width:1;color:Gray;background-color:Gray">
<br>


